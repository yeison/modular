# ===----------------------------------------------------------------------=== #
# Copyright (c) 2025, Modular Inc. All rights reserved.
#
# Licensed under the Apache License v2.0 with LLVM Exceptions:
# https://llvm.org/LICENSE.txt
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
# ===----------------------------------------------------------------------=== #

from gpu import WARP_SIZE, lane_id
from gpu.host import DeviceContext
from layout import Layout, LayoutTensor
from layout._fillers import arange
from layout.tensor_builder import LayoutTensorBuild as tb
from layout.tensor_core import TensorCore
from utils.index import Index, IndexList
from test_tensor_core_amd_utils import test_load_and_mma_and_multiply_operands

alias fp8_dtype = DType.float8_e4m3fnuz
alias bf8_dtype = DType.float8_e5m2fnuz


# CHECK-LABEL: == test_load_and_mma_f32_f8_16x16x32
# CHECK-LABEL: == test_load_a
# CHECK: 0.0 0.1015625 0.203125 0.3125 0.40625 0.5 0.625 0.6875 0.8125 0.875 1.0 1.125 1.25 1.25 1.375 1.5 1.625 1.75 1.75 1.875 2.0 2.0 2.25 2.25 2.5 2.5 2.5 2.75 2.75 3.0 3.0 3.0 3.25 3.25 3.5 3.5 3.5 3.75 3.75 4.0 4.0 4.0 4.0 4.5 4.5 4.5 4.5 4.5 5.0 5.0 5.0 5.0 5.0 5.5 5.5 5.5 5.5 5.5 6.0 6.0 6.0 6.0 6.0 6.5
# CHECK-LABEL: == test_load_b
# CHECK: 0.0 0.203125 0.40625 0.625 0.8125 1.0 1.25 1.375 1.625 1.75 2.0 2.25 2.5 2.5 2.75 3.0 0.8125 1.0 1.25 1.375 1.625 1.75 2.0 2.25 2.5 2.5 2.75 3.0 3.25 3.5 3.5 3.75 1.625 1.75 2.0 2.25 2.5 2.5 2.75 3.0 3.25 3.5 3.5 3.75 4.0 4.0 4.5 4.5 2.5 2.5 2.75 3.0 3.25 3.5 3.5 3.75 4.0 4.0 4.5 4.5 5.0 5.0 5.0 5.5
# CHECK-LABEL: == test_load_c
# CHECK: 0.0 16.0 32.0 48.0
# CHECK: 1.0 17.0 33.0 49.0
# CHECK: 2.0 18.0 34.0 50.0
# CHECK: 3.0 19.0 35.0 51.0
# CHECK: 4.0 20.0 36.0 52.0
# CHECK: 5.0 21.0 37.0 53.0
# CHECK: 6.0 22.0 38.0 54.0
# CHECK: 7.0 23.0 39.0 55.0
# CHECK: 8.0 24.0 40.0 56.0
# CHECK: 9.0 25.0 41.0 57.0
# CHECK: 10.0 26.0 42.0 58.0
# CHECK: 11.0 27.0 43.0 59.0
# CHECK: 12.0 28.0 44.0 60.0
# CHECK: 13.0 29.0 45.0 61.0
# CHECK: 14.0 30.0 46.0 62.0
# CHECK: 15.0 31.0 47.0 63.0
# CHECK: 64.0 80.0 96.0 112.0
# CHECK: 65.0 81.0 97.0 113.0
# CHECK: 66.0 82.0 98.0 114.0
# CHECK: 67.0 83.0 99.0 115.0
# CHECK: 68.0 84.0 100.0 116.0
# CHECK: 69.0 85.0 101.0 117.0
# CHECK: 70.0 86.0 102.0 118.0
# CHECK: 71.0 87.0 103.0 119.0
# CHECK: 72.0 88.0 104.0 120.0
# CHECK: 73.0 89.0 105.0 121.0
# CHECK: 74.0 90.0 106.0 122.0
# CHECK: 75.0 91.0 107.0 123.0
# CHECK: 76.0 92.0 108.0 124.0
# CHECK: 77.0 93.0 109.0 125.0
# CHECK: 78.0 94.0 110.0 126.0
# CHECK: 79.0 95.0 111.0 127.0
# CHECK: 128.0 144.0 160.0 176.0
# CHECK: 129.0 145.0 161.0 177.0
# CHECK: 130.0 146.0 162.0 178.0
# CHECK: 131.0 147.0 163.0 179.0
# CHECK: 132.0 148.0 164.0 180.0
# CHECK: 133.0 149.0 165.0 181.0
# CHECK: 134.0 150.0 166.0 182.0
# CHECK: 135.0 151.0 167.0 183.0
# CHECK: 136.0 152.0 168.0 184.0
# CHECK: 137.0 153.0 169.0 185.0
# CHECK: 138.0 154.0 170.0 186.0
# CHECK: 139.0 155.0 171.0 187.0
# CHECK: 140.0 156.0 172.0 188.0
# CHECK: 141.0 157.0 173.0 189.0
# CHECK: 142.0 158.0 174.0 190.0
# CHECK: 143.0 159.0 175.0 191.0
# CHECK: 192.0 208.0 224.0 240.0
# CHECK: 193.0 209.0 225.0 241.0
# CHECK: 194.0 210.0 226.0 242.0
# CHECK: 195.0 211.0 227.0 243.0
# CHECK: 196.0 212.0 228.0 244.0
# CHECK: 197.0 213.0 229.0 245.0
# CHECK: 198.0 214.0 230.0 246.0
# CHECK: 199.0 215.0 231.0 247.0
# CHECK: 200.0 216.0 232.0 248.0
# CHECK: 201.0 217.0 233.0 249.0
# CHECK: 202.0 218.0 234.0 250.0
# CHECK: 203.0 219.0 235.0 251.0
# CHECK: 204.0 220.0 236.0 252.0
# CHECK: 205.0 221.0 237.0 253.0
# CHECK: 206.0 222.0 238.0 254.0
# CHECK: 207.0 223.0 239.0 255.0
# CHECK-LABEL: == test_load_d
# CHECK: 0.0 1.0 2.0 3.0 4.0 5.0 6.0 7.0 8.0 9.0 10.0 11.0 12.0 13.0 14.0 15.0
# CHECK: 0.0 1.0 2.0 3.0 4.0 5.0 6.0 7.0 8.0 9.0 10.0 11.0 12.0 13.0 14.0 15.0
# CHECK: 0.0 1.0 2.0 3.0 4.0 5.0 6.0 7.0 8.0 9.0 10.0 11.0 12.0 13.0 14.0 15.0
# CHECK: 0.0 1.0 2.0 3.0 4.0 5.0 6.0 7.0 8.0 9.0 10.0 11.0 12.0 13.0 14.0 15.0
# CHECK: 16.0 17.0 18.0 19.0 20.0 21.0 22.0 23.0 24.0 25.0 26.0 27.0 28.0 29.0 30.0 31.0
# CHECK: 16.0 17.0 18.0 19.0 20.0 21.0 22.0 23.0 24.0 25.0 26.0 27.0 28.0 29.0 30.0 31.0
# CHECK: 16.0 17.0 18.0 19.0 20.0 21.0 22.0 23.0 24.0 25.0 26.0 27.0 28.0 29.0 30.0 31.0
# CHECK: 16.0 17.0 18.0 19.0 20.0 21.0 22.0 23.0 24.0 25.0 26.0 27.0 28.0 29.0 30.0 31.0
# CHECK: 32.0 33.0 34.0 35.0 36.0 37.0 38.0 39.0 40.0 41.0 42.0 43.0 44.0 45.0 46.0 47.0
# CHECK: 32.0 33.0 34.0 35.0 36.0 37.0 38.0 39.0 40.0 41.0 42.0 43.0 44.0 45.0 46.0 47.0
# CHECK: 32.0 33.0 34.0 35.0 36.0 37.0 38.0 39.0 40.0 41.0 42.0 43.0 44.0 45.0 46.0 47.0
# CHECK: 32.0 33.0 34.0 35.0 36.0 37.0 38.0 39.0 40.0 41.0 42.0 43.0 44.0 45.0 46.0 47.0
# CHECK: 48.0 49.0 50.0 51.0 52.0 53.0 54.0 55.0 56.0 57.0 58.0 59.0 60.0 61.0 62.0 63.0
# CHECK: 48.0 49.0 50.0 51.0 52.0 53.0 54.0 55.0 56.0 57.0 58.0 59.0 60.0 61.0 62.0 63.0
# CHECK: 48.0 49.0 50.0 51.0 52.0 53.0 54.0 55.0 56.0 57.0 58.0 59.0 60.0 61.0 62.0 63.0
# CHECK: 48.0 49.0 50.0 51.0 52.0 53.0 54.0 55.0 56.0 57.0 58.0 59.0 60.0 61.0 62.0 63.0
# CHECK-LABEL: == test_mma
# CHECK: 207.33166 228.01758 249.39844 269.90723 291.13086 311.44726 332.21094 353.69922 372.70703 395.33398 415.6328 436.3789 458.0078 477.01953 499.53125 519.6797
# CHECK: 229.07861 250.54797 272.70923 293.98926 315.9419 336.6875 358.25195 380.4209 400.00098 423.54492 444.3125 466.11914 488.17578 507.61328 531.06055 551.91406
# CHECK: 249.3518 271.4768 294.28174 316.25 338.60644 359.97266 382.23047 404.98242 425.2832 449.3047 470.92188 493.1836 515.6953 535.90625 559.96484 581.59375
# CHECK: 270.95996 293.81152 317.38476 339.6914 362.7539 384.90625 407.8203 431.35938 452.10156 477.01563 499.17187 521.8594 545.34375 566.1094 591.1406 613.1719
# CHECK: 291.01758 314.56104 338.4541 361.42188 385.14258 407.95312 431.46875 455.45703 476.89453 502.35156 524.9531 548.47656 572.4219 594.0 619.46094 641.9219
# CHECK: 312.42725 336.29688 360.9297 384.63672 409.08594 432.58594 456.48438 481.23437 503.3125 529.28906 552.78125 576.7344 601.6875 623.6406 649.5 672.84375
# CHECK: 333.53174 358.18555 383.5586 407.9961 433.21875 457.08594 481.8125 507.21875 529.84375 556.7422 580.6875 605.7031 631.0625 653.4219 680.28125 704.1875
# CHECK: 354.44238 379.78418 405.8418 431.0078 456.52734 481.0625 506.53125 532.5547 555.9297 583.21875 608.03125 633.5469 659.28125 682.5625 709.9531 734.78125
# CHECK: 375.39844 401.4541 428.2832 453.72656 479.98828 505.26562 531.34375 558.1797 581.96094 610.1406 635.46875 661.3906 688.15625 711.84375 740.2656 765.46875
# CHECK: 396.12598 422.85742 449.98047 476.1328 503.10156 529.0781 555.8125 583.0 607.5156 636.2969 662.125 688.90625 716.0625 740.71875 769.5 795.0625
# CHECK: 416.875 443.94922 471.8047 498.64844 526.2969 553.0 580.0469 608.0156 633.1406 662.40625 689.125 716.3125 744.46875 769.46875 798.625 825.125
# CHECK: 438.63086 466.47852 495.1211 522.75 551.22656 578.2031 606.1406 634.8281 660.5469 690.78125 717.875 746.15625 774.78125 800.125 830.4375 857.4375
# CHECK: 458.90723 487.42187 516.72656 545.0781 573.78125 601.4531 630.0781 659.3281 685.8125 716.3906 744.34375 773.09375 802.0625 828.375 859.0625 887.03125
# CHECK: 480.48438 509.76172 539.8281 568.4375 597.9375 626.40625 655.6875 685.8125 712.6094 744.125 772.65625 801.875 831.90625 858.5625 890.4375 918.71875
# CHECK: 500.60644 530.49805 560.85547 590.14844 620.28906 649.3906 679.34375 709.7344 737.2656 769.3281 798.3125 828.375 858.75 886.34375 918.53125 947.125
# CHECK: 521.9414 552.2539 583.3594 613.41406 644.3125 674.21875 704.4219 735.6719 763.90625 796.53125 826.46875 856.875 888.3125 916.34375 948.875 978.59375


def test_load_and_mma_f32_f8_16x16x32(ctx: DeviceContext):
    print("== test_load_and_mma_f32_f8_16x16x32")
    test_load_and_mma_and_multiply_operands[
        DType.float32, fp8_dtype, Index(16, 16, 32), False
    ](ctx)


# CHECK-LABEL: == test_load_and_mma_f32_f8_16x16x32_transpose
# CHECK-LABEL: == test_load_a
# CHECK: 0.0 0.1015625 0.203125 0.3125 0.40625 0.5 0.625 0.6875 0.8125 0.875 1.0 1.125 1.25 1.25 1.375 1.5 1.625 1.75 1.75 1.875 2.0 2.0 2.25 2.25 2.5 2.5 2.5 2.75 2.75 3.0 3.0 3.0 3.25 3.25 3.5 3.5 3.5 3.75 3.75 4.0 4.0 4.0 4.0 4.5 4.5 4.5 4.5 4.5 5.0 5.0 5.0 5.0 5.0 5.5 5.5 5.5 5.5 5.5 6.0 6.0 6.0 6.0 6.0 6.
# CHECK-LABEL: == test_load_b
# CHECK: 0.0 0.1015625 0.203125 0.3125 0.40625 0.5 0.625 0.6875 0.8125 0.875 1.0 1.125 1.25 1.25 1.375 1.5 1.625 1.75 1.75 1.875 2.0 2.0 2.25 2.25 2.5 2.5 2.5 2.75 2.75 3.0 3.0 3.0 3.25 3.25 3.5 3.5 3.5 3.75 3.75 4.0 4.0 4.0 4.0 4.5 4.5 4.5 4.5 4.5 5.0 5.0 5.0 5.0 5.0 5.5 5.5 5.5 5.5 5.5 6.0 6.0 6.0 6.0 6.0 6.
# CHECK-LABEL: == test_load_c
# CHECK: 0.0 16.0 32.0 48.0
# CHECK: 1.0 17.0 33.0 49.0
# CHECK: 2.0 18.0 34.0 50.0
# CHECK: 3.0 19.0 35.0 51.0
# CHECK: 4.0 20.0 36.0 52.0
# CHECK: 5.0 21.0 37.0 53.0
# CHECK: 6.0 22.0 38.0 54.0
# CHECK: 7.0 23.0 39.0 55.0
# CHECK: 8.0 24.0 40.0 56.0
# CHECK: 9.0 25.0 41.0 57.0
# CHECK: 10.0 26.0 42.0 58.0
# CHECK: 11.0 27.0 43.0 59.0
# CHECK: 12.0 28.0 44.0 60.0
# CHECK: 13.0 29.0 45.0 61.0
# CHECK: 14.0 30.0 46.0 62.0
# CHECK: 15.0 31.0 47.0 63.0
# CHECK: 64.0 80.0 96.0 112.0
# CHECK: 65.0 81.0 97.0 113.0
# CHECK: 66.0 82.0 98.0 114.0
# CHECK: 67.0 83.0 99.0 115.0
# CHECK: 68.0 84.0 100.0 116.0
# CHECK: 69.0 85.0 101.0 117.0
# CHECK: 70.0 86.0 102.0 118.0
# CHECK: 71.0 87.0 103.0 119.0
# CHECK: 72.0 88.0 104.0 120.0
# CHECK: 73.0 89.0 105.0 121.0
# CHECK: 74.0 90.0 106.0 122.0
# CHECK: 75.0 91.0 107.0 123.0
# CHECK: 76.0 92.0 108.0 124.0
# CHECK: 77.0 93.0 109.0 125.0
# CHECK: 78.0 94.0 110.0 126.0
# CHECK: 79.0 95.0 111.0 127.0
# CHECK: 128.0 144.0 160.0 176.0
# CHECK: 129.0 145.0 161.0 177.0
# CHECK: 130.0 146.0 162.0 178.0
# CHECK: 131.0 147.0 163.0 179.0
# CHECK: 132.0 148.0 164.0 180.0
# CHECK: 133.0 149.0 165.0 181.0
# CHECK: 134.0 150.0 166.0 182.0
# CHECK: 135.0 151.0 167.0 183.0
# CHECK: 136.0 152.0 168.0 184.0
# CHECK: 137.0 153.0 169.0 185.0
# CHECK: 138.0 154.0 170.0 186.0
# CHECK: 139.0 155.0 171.0 187.0
# CHECK: 140.0 156.0 172.0 188.0
# CHECK: 141.0 157.0 173.0 189.0
# CHECK: 142.0 158.0 174.0 190.0
# CHECK: 143.0 159.0 175.0 191.0
# CHECK: 192.0 208.0 224.0 240.0
# CHECK: 193.0 209.0 225.0 241.0
# CHECK: 194.0 210.0 226.0 242.0
# CHECK: 195.0 211.0 227.0 243.0
# CHECK: 196.0 212.0 228.0 244.0
# CHECK: 197.0 213.0 229.0 245.0
# CHECK: 198.0 214.0 230.0 246.0
# CHECK: 199.0 215.0 231.0 247.0
# CHECK: 200.0 216.0 232.0 248.0
# CHECK: 201.0 217.0 233.0 249.0
# CHECK: 202.0 218.0 234.0 250.0
# CHECK: 203.0 219.0 235.0 251.0
# CHECK: 204.0 220.0 236.0 252.0
# CHECK: 205.0 221.0 237.0 253.0
# CHECK: 206.0 222.0 238.0 254.0
# CHECK: 207.0 223.0 239.0 255.0
# CHECK-LABEL: == test_load_d
# CHECK: 0.0 1.0 2.0 3.0 4.0 5.0 6.0 7.0 8.0 9.0 10.0 11.0 12.0 13.0 14.0 15.0
# CHECK: 0.0 1.0 2.0 3.0 4.0 5.0 6.0 7.0 8.0 9.0 10.0 11.0 12.0 13.0 14.0 15.0
# CHECK: 0.0 1.0 2.0 3.0 4.0 5.0 6.0 7.0 8.0 9.0 10.0 11.0 12.0 13.0 14.0 15.0
# CHECK: 0.0 1.0 2.0 3.0 4.0 5.0 6.0 7.0 8.0 9.0 10.0 11.0 12.0 13.0 14.0 15.0
# CHECK: 16.0 17.0 18.0 19.0 20.0 21.0 22.0 23.0 24.0 25.0 26.0 27.0 28.0 29.0 30.0 31.0
# CHECK: 16.0 17.0 18.0 19.0 20.0 21.0 22.0 23.0 24.0 25.0 26.0 27.0 28.0 29.0 30.0 31.0
# CHECK: 16.0 17.0 18.0 19.0 20.0 21.0 22.0 23.0 24.0 25.0 26.0 27.0 28.0 29.0 30.0 31.0
# CHECK: 16.0 17.0 18.0 19.0 20.0 21.0 22.0 23.0 24.0 25.0 26.0 27.0 28.0 29.0 30.0 31.0
# CHECK: 32.0 33.0 34.0 35.0 36.0 37.0 38.0 39.0 40.0 41.0 42.0 43.0 44.0 45.0 46.0 47.0
# CHECK: 32.0 33.0 34.0 35.0 36.0 37.0 38.0 39.0 40.0 41.0 42.0 43.0 44.0 45.0 46.0 47.0
# CHECK: 32.0 33.0 34.0 35.0 36.0 37.0 38.0 39.0 40.0 41.0 42.0 43.0 44.0 45.0 46.0 47.0
# CHECK: 32.0 33.0 34.0 35.0 36.0 37.0 38.0 39.0 40.0 41.0 42.0 43.0 44.0 45.0 46.0 47.0
# CHECK: 48.0 49.0 50.0 51.0 52.0 53.0 54.0 55.0 56.0 57.0 58.0 59.0 60.0 61.0 62.0 63.0
# CHECK: 48.0 49.0 50.0 51.0 52.0 53.0 54.0 55.0 56.0 57.0 58.0 59.0 60.0 61.0 62.0 63.0
# CHECK: 48.0 49.0 50.0 51.0 52.0 53.0 54.0 55.0 56.0 57.0 58.0 59.0 60.0 61.0 62.0 63.0
# CHECK: 48.0 49.0 50.0 51.0 52.0 53.0 54.0 55.0 56.0 57.0 58.0 59.0 60.0 61.0 62.0 63.0
# CHECK-LABEL: == test_mma
# CHECK: 414.66333 427.15723 436.7036 448.91992 458.03516 469.8545 481.06348 491.88477 502.79687 513.25195 523.75 536.2617 545.81445 557.96875 567.2129 578.8828
# CHECK: 442.15723 455.7525 465.39368 477.80518 487.09595 499.10156 511.333 522.32764 533.41846 544.01856 554.7344 568.22363 577.9785 590.291 599.64746 611.6367
# CHECK: 466.7036 480.39368 490.91333 503.40723 512.9536 525.1699 537.53516 549.3545 560.5635 571.38477 582.2969 596.00195 606.5 619.0117 628.56445 640.71875
# CHECK: 493.91992 507.80518 518.4072 531.9922 541.62305 554.02344 566.5547 578.5508 590.7695 601.7578 612.83594 626.6797 637.3828 650.8594 660.60156 672.91406
# CHECK: 518.03516 532.09595 542.9536 556.62305 567.1221 579.59375 592.3711 604.56836 616.9082 628.71484 639.89844 653.95703 664.84375 678.52344 688.9961 701.5078
# CHECK: 544.8545 559.10156 570.1699 584.02344 594.59375 608.1445 620.9961 633.3672 645.8594 657.83594 670.0156 684.2344 695.27344 709.0781 719.7422 733.21875
# CHECK: 571.0635 586.333 597.53516 611.5547 622.3711 635.9961 649.957 662.3906 675.1172 687.28906 699.5781 714.8594 725.9922 740.0 750.83594 764.5156
# CHECK: 596.88477 612.32764 624.3545 638.5508 649.56836 663.3672 677.3906 690.89453 703.6836 716.02344 728.4531 743.89844 756.0156 770.1719 781.14844 794.9531
# CHECK: 622.7969 638.41846 650.5635 665.76953 676.9082 690.8594 705.1172 718.6836 732.5664 744.96094 757.6094 773.2422 785.4531 800.65625 811.71094 825.71875
# CHECK: 648.25195 664.01856 676.38477 691.7578 703.71484 717.83594 732.28906 746.02344 759.96094 773.4219 786.125 801.9219 814.2656 829.625 841.65625 855.8125
# CHECK: 673.75 689.7344 702.2969 717.83594 729.89844 745.0156 759.5781 773.4531 787.6094 801.125 814.90625 830.75 843.2969 858.8281 870.9375 886.1406
# CHECK: 701.2617 718.22363 731.00195 746.6797 758.957 774.2344 789.8594 803.89844 818.2422 831.9219 845.75 862.90625 875.5 891.1875 903.4219 918.78125
# CHECK: 725.81445 742.9785 756.5 772.3828 784.84375 800.27344 815.9922 831.0156 845.4531 859.2656 873.2969 890.5 904.15625 919.875 932.2969 947.8281
# CHECK: 752.96875 770.291 784.0117 800.8594 813.52344 829.0781 845.0 860.1719 875.65625 889.625 903.8281 921.1875 934.875 951.8906 964.34375 980.03125
# CHECK: 777.2129 794.64746 808.56445 825.60156 838.9961 854.7422 870.83594 886.14844 901.71094 916.65625 930.9375 948.4219 962.2969 979.34375 992.84375 1008.5625
# CHECK: 803.8828 821.6367 835.71875 852.91406 866.5078 883.21875 899.5156 914.9531 930.71875 945.8125 961.1406 978.78125 992.8281 1010.03125 1023.5625 1040.5781


def test_load_and_mma_f32_f8_16x16x32_transpose(ctx: DeviceContext):
    print("== test_load_and_mma_f32_f8_16x16x32_transpose")
    test_load_and_mma_and_multiply_operands[
        DType.float32, fp8_dtype, Index(16, 16, 32), True
    ](ctx)


def main():
    with DeviceContext() as ctx:
        test_load_and_mma_f32_f8_16x16x32(ctx)
        test_load_and_mma_f32_f8_16x16x32_transpose(ctx)
